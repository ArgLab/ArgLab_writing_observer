# Define upstream servers
upstream server0 { server localhost:8888; }
upstream server1 { server localhost:8889; }
upstream server2 { server localhost:8890; }

# Extract first character of the student-id header
map $http_student $upstream_server {
    default server0;   # default if no match or header is absent
    "~^[0]" server0;
    "~^[1]" server1;
    "~^[2]" server2;
    "~^[3]" server0;
    "~^[4]" server1;
    "~^[5]" server2;
    "~^[6]" server0;
    "~^[7]" server1;
    "~^[8]" server2;
    "~^[9]" server0;
    "~^[aA]" server1;
    "~^[bB]" server2;
    "~^[cC]" server0;
    "~^[dD]" server1;
    "~^[eE]" server2;
    "~^[fF]" server0;
}

server {
    listen 80;

    location / {
        proxy_set_header Student $http_student;

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Pass original host to the upstream server
        proxy_set_header Host $host;
        
        # Other WebSocket headers
        proxy_http_version 1.1;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Route the request to the selected upstream server
        proxy_pass http://$upstream_server;
        proxy_read_timeout 3600;
        proxy_send_timeout 3600;
    }
}


